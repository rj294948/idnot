<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Facebook Sync - RJ Multi Stone Hub</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* SAME STYLES YOU USED – KEEP THEM */
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1><i class="fab fa-facebook"></i> Facebook Sync</h1>
        <p>Auto-posting to RJ Multi Stone Hub</p>
    </div>

    <div class="content">
        <a href="admin.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Admin Panel
        </a>

        <div id="notification" class="notification"></div>

        <!-- Settings -->
        <div class="setup-section">
            <h2><i class="fas fa-check-circle"></i> Facebook Configuration</h2>

            <div class="config-form">
                <div class="form-group">
                    <label>Facebook Page Access Token</label>
                    <input id="page-token" placeholder="EAA..." />
                </div>

                <div class="form-group">
                    <label>Facebook Page ID</label>
                    <input id="page-id" value="950920808095297" />
                </div>

                <button class="btn btn-primary" onclick="saveConfig()">
                    Save Configuration
                </button>

                <button class="btn btn-info" onclick="testFB()">
                    Test Connection
                </button>
            </div>
        </div>

        <!-- Products -->
        <div class="setup-section">
            <h2><i class="fas fa-cubes"></i> Manage Products</h2>

            <button class="btn btn-success" onclick="syncAllProducts()">
                Sync All to Facebook
            </button>

            <button class="btn btn-primary" onclick="loadProducts()">
                Refresh Products
            </button>

            <div id="products-container" class="products-grid">
                Loading products...
            </div>
        </div>
    </div>
</div>

<script type="module">
import { db, collection, getDocs, doc, updateDoc, serverTimestamp } from "./firebase-config.js";

let products = [];
let fbConfig = {};

function show(msg, type="success"){
    const n = document.getElementById("notification");
    n.textContent = msg;
    n.className = "notification " + type;
}

function saveConfig(){
    fbConfig = {
        pageId: document.getElementById("page-id").value.trim(),
        pageToken: document.getElementById("page-token").value.trim(),
    };
    localStorage.setItem("fbConfig", JSON.stringify(fbConfig));
    show("Saved!", "success");
}

function loadConfig(){
    const x = localStorage.getItem("fbConfig");
    if(x){
        fbConfig = JSON.parse(x);
        document.getElementById("page-id").value = fbConfig.pageId;
        document.getElementById("page-token").value = fbConfig.pageToken;
    }
}

async function testFB(){
    show("Testing Facebook connection...");

    const res = await fetch("https://your-backend-url.vercel.app/test", {
        method: "POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(fbConfig)
    });

    const data = await res.json();
    if(data.success){
        show("Connected to page: " + data.page_name, "success");
    } else {
        show("ERROR: " + data.error, "error");
    }
}

async function loadProducts(){
    show("Loading products...");
    const q = await getDocs(collection(db, "products"));

    products = [];
    q.forEach(d => products.push({ id: d.id, ...d.data() }));

    render();
    show("Products loaded!", "success");
}

function render(){
    const box = document.getElementById("products-container");
    box.innerHTML = products.map(p => `
        <div class="product-card">
            <img class="product-image" src="${p.images?.[0] || 'https://via.placeholder.com'}">
            <h3>${p.stone_name}</h3>
            <p>₹${p.price} ${p.price_unit}</p>
            <p>${p.category}</p>

            <div class="facebook-status ${p.posted_to_facebook ? "status-posted" : "status-not-posted"}">
                ${p.posted_to_facebook ? "Posted" : "Not Posted"}
            </div>

            <button class="btn btn-success" onclick="postProduct('${p.id}')">
                Post to Facebook
            </button>
        </div>
    `).join("");
}

window.postProduct = async function(id){
    const p = products.find(x => x.id === id);

    show("Posting product to Facebook...");

    const res = await fetch("https://your-backend-url.vercel.app/post", {
        method: "POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ product:p, config:fbConfig })
    });

    const data = await res.json();

    if(data.success){
        await updateDoc(doc(db, "products", id), {
            posted_to_facebook: true,
            facebook_post_url: data.post_url,
            posted_at: serverTimestamp()
        });

        show("Posted successfully!", "success");
        loadProducts();
    } else {
        show("ERROR: " + data.error, "error");
    }
}

window.syncAllProducts = async function(){
    const notPosted = products.filter(p => !p.posted_to_facebook);
    for(let p of notPosted){
        await postProduct(p.id);
        await new Promise(r => setTimeout(r, 3000));
    }
};

loadConfig();
loadProducts();
</script>

</body>
</html>
