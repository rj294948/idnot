<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Product - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ===== General Styles ===== */
:root {
  --primary: #c7a97b;
  --primary-dark: #a58a62;
  --secondary: #5a4a3a;
  --light: #f8f5f0;
  --dark: #333;
  --gray: #e0e0e0;
  --success: #28a745;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
  --shadow: 0 4px 12px rgba(0,0,0,0.1);
  --radius: 8px;
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: var(--dark);
  background: var(--light);
  display: flex;
  min-height: 100vh;
}

/* ===== Sidebar ===== */
.sidebar {
  width: 250px;
  background: var(--primary);
  color: white;
  padding: 20px 0;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  z-index: 1000;
  transition: var(--transition);
}

.sidebar-header {
  padding: 0 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.3rem;
  font-weight: 700;
}

.sidebar-logo img {
  height: 40px;
  border-radius: 5px;
}

.sidebar-nav {
  list-style: none;
}

.sidebar-nav a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  color: white;
  text-decoration: none;
  transition: var(--transition);
  border-left: 3px solid transparent;
}

.sidebar-nav a:hover, .sidebar-nav a.active {
  background: rgba(255,255,255,0.1);
  border-left-color: white;
}

.sidebar-nav i {
  width: 20px;
  text-align: center;
}

/* ===== Main Content ===== */
.main-content {
  flex: 1;
  margin-left: 250px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== Header ===== */
.top-header {
  background: white;
  padding: 15px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 999;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 15px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--light);
  padding: 8px 15px;
  border-radius: var(--radius);
}

.user-avatar {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.header-actions {
  display: flex;
  gap: 10px;
}

.btn {
  padding: 8px 16px;
  border-radius: var(--radius);
  font-weight: 600;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  border: none;
  text-decoration: none;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--primary);
  color: var(--primary);
}

.btn-outline:hover {
  background: var(--primary);
  color: white;
}

/* ===== Container ===== */
.container {
  padding: 30px;
  flex: 1;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

.page-title {
  text-align: center;
  margin-bottom: 30px;
  position: relative;
  padding-bottom: 15px;
  color: var(--secondary);
  font-size: 2rem;
}

.page-title:after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: var(--primary);
}

/* ===== Form Styles ===== */
.form-container {
  background: white;
  padding: 40px;
  border-radius: 15px;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray);
}

.form-group {
  margin-bottom: 25px;
}

.form-group label {
  display: block;
  margin-bottom: 10px;
  color: var(--secondary);
  font-weight: 600;
  font-size: 1rem;
}

.form-group label.required:after {
  content: " *";
  color: var(--danger);
}

select, input, textarea {
  width: 100%;
  padding: 14px 16px;
  border-radius: var(--radius);
  border: 1px solid var(--gray);
  font-size: 1rem;
  transition: var(--transition);
  background: #fafafa;
}

select:focus, input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(199,169,123,0.2);
  background: white;
}

.phone-input-container {
  position: relative;
}

.phone-prefix {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--secondary);
  font-weight: 600;
}

.country-code-input {
  padding-left: 50px !important;
}

.country-code-prefix {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--secondary);
  font-weight: 600;
  background: var(--light);
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid var(--gray);
}

.submit-btn {
  background: var(--primary);
  color: white;
  font-weight: 600;
  border: none;
  padding: 16px 32px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 1.1rem;
  transition: var(--transition);
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.submit-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

.submit-btn:disabled {
  background: var(--gray);
  cursor: not-allowed;
  transform: none;
}

/* ===== Form Sections ===== */
.form-section {
  margin-bottom: 40px;
  padding-bottom: 30px;
  border-bottom: 2px solid var(--light);
}

.section-title {
  font-size: 1.4rem;
  color: var(--primary);
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ===== Additional Fields ===== */
.additional-fields-section {
  background: var(--light);
  padding: 25px;
  border-radius: var(--radius);
  margin-top: 30px;
  border: 2px dashed var(--primary);
}

.add-field-btn {
  background: var(--info);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 15px;
  transition: var(--transition);
}

.add-field-btn:hover {
  background: #138496;
}

.additional-field {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  align-items: flex-end;
}

.field-input {
  flex: 1;
}

.remove-field-btn {
  background: var(--danger);
  color: white;
  border: none;
  padding: 12px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--transition);
  height: fit-content;
}

.remove-field-btn:hover {
  background: #c82333;
}

/* ===== Image Upload ===== */
.image-upload-section {
  margin: 20px 0;
}

.upload-options {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.upload-btn {
  padding: 12px 20px;
  border: 2px dashed var(--primary);
  border-radius: var(--radius);
  background: var(--light);
  color: var(--primary);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 200px;
  justify-content: center;
}

.upload-btn:hover {
  background: var(--primary);
  color: white;
  border-style: solid;
}

.preview {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin: 20px 0;
  padding: 15px;
  background: var(--light);
  border-radius: var(--radius);
  min-height: 100px;
}

.preview-item {
  position: relative;
  display: inline-block;
}

.preview img {
  width: 150px;
  height: 150px;
  object-fit: cover;
  border-radius: var(--radius);
  border: 2px solid var(--gray);
  transition: var(--transition);
}

.preview img:hover {
  transform: scale(1.05);
  border-color: var(--primary);
}

.remove-image {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== Processing Overlay ===== */
.processing-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 4000;
  flex-direction: column;
}

.processing-overlay.active {
  display: flex;
}

.processing-content {
  background: white;
  padding: 40px;
  border-radius: 15px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

.processing-spinner {
  width: 60px;
  height: 60px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== Footer ===== */
footer {
  background: var(--dark);
  color: white;
  text-align: center;
  padding: 20px;
  margin-top: auto;
}

/* ===== Utility Styles ===== */
.field-hint {
  color: #666;
  font-size: 0.85rem;
  margin-top: 5px;
  display: block;
}

.compulsory-note {
  text-align: center;
  color: var(--danger);
  font-size: 0.9rem;
  margin-bottom: 20px;
  font-weight: 600;
}

.error-message {
  color: var(--danger);
  font-size: 0.9rem;
  margin-top: 5px;
  display: none;
}

.error-message.show {
  display: block;
}

/* ===== Responsive Design ===== */
@media (max-width: 768px) {
  .sidebar {
    width: 100%;
    transform: translateX(-100%);
    position: fixed;
  }
  
  .sidebar.active {
    transform: translateX(0);
  }
  
  .main-content {
    margin-left: 0;
  }
  
  .container {
    padding: 20px;
  }
  
  .form-container {
    padding: 25px;
  }
  
  .upload-options {
    flex-direction: column;
  }
  
  .upload-btn {
    min-width: 100%;
  }
  
  .additional-field {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<!-- ===== Sidebar ===== -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <img src="stone.png" alt="Rajasthan Stones Logo">
      <span>Rajasthan Stones</span>
    </div>
  </div>
  <ul class="sidebar-nav">
    <li><a href="index.html"><i class="fas fa-home"></i> <span>Home</span></a></li>
    <li><a href="add-product.html" class="active"><i class="fas fa-plus-circle"></i> <span>Add Product</span></a></li>
    <li><a href="products.html"><i class="fas fa-boxes"></i> <span>View Products</span></a></li>
    <li><a href="history.html"><i class="fas fa-history"></i> <span>My History</span></a></li>
  </ul>
</div>

<!-- ===== Main Content ===== -->
<div class="main-content" id="main-content">
  <!-- ===== Top Header ===== -->
  <header class="top-header">
    <div class="header-actions">
      <button class="btn btn-outline" onclick="window.location='index.html'">
        <i class="fas fa-home"></i> Home
      </button>
      <button id="btn-signout" class="btn btn-outline" style="display:none;">Sign Out</button>
    </div>
    <div class="user-profile">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">G</div>
        <span class="user-name" id="user-name">Guest User</span>
      </div>
    </div>
  </header>

  <!-- ===== Main Container ===== -->
  <div class="container">
    <h1 class="page-title">Add Stone Product</h1>
    
    <div class="compulsory-note">
      <i class="fas fa-exclamation-circle"></i> Fields marked with * are compulsory
    </div>

    <div class="form-container">
      <form id="product-form">
        <input type="hidden" id="product-id">

        <!-- ===== Basic Information Section ===== -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-info-circle"></i> Basic Information</h3>
          
          <div class="form-group">
            <label for="category" class="required">Category</label>
            <select id="category" required>
              <option value="">Select Category</option>
              <option value="sandstone">Sand Stone</option>
              <option value="kota">Kota Stone</option>
              <option value="granite">Granite</option>
              <option value="marble">Marble</option>
              <option value="dholpur">Dholpur</option>
              <option value="tiles">Tiles</option>
              <option value="mandana">Mandana</option>
              <option value="other">Other Stones</option>
            </select>
            <span class="field-hint">Select the main category of your stone product</span>
          </div>

          <div class="form-group">
            <label for="stone_name" class="required">Stone Name</label>
            <input type="text" id="stone_name" placeholder="Enter stone name" required>
            <span class="field-hint">Name of the stone product (e.g., Raj Green Sandstone, White Marble, etc.)</span>
          </div>

          <div class="form-group">
            <label for="sub_category">Sub-category</label>
            <input type="text" id="sub_category" placeholder="Enter sub-category">
            <span class="field-hint">Optional: Slabs, Tiles, Blocks, etc.</span>
          </div>
        </div>

        <!-- ===== Product Details Section ===== -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-cube"></i> Product Details</h3>
          
          <div class="form-group">
            <label for="type">Type</label>
            <input type="text" id="type" placeholder="Enter type">
            <span class="field-hint">Optional: Natural, Calibrated, Polished, Honed, etc.</span>
          </div>

          <div class="form-group">
            <label for="color">Color</label>
            <input type="text" id="color" placeholder="Enter color">
            <span class="field-hint">Optional: Green, Brown, White, Black, etc.</span>
          </div>

          <div class="form-group">
            <label for="thickness">Thickness</label>
            <input type="text" id="thickness" placeholder="Enter thickness">
            <span class="field-hint">Optional: 20-40 mm, 10-20 mm, etc.</span>
          </div>

          <div class="form-group">
            <label for="size">Size</label>
            <input type="text" id="size" placeholder="Enter size">
            <span class="field-hint">Optional: Custom sizes, Standard tiles, Slabs dimensions</span>
          </div>

          <div class="form-group">
            <label for="finish">Finish</label>
            <input type="text" id="finish" placeholder="Enter finish">
            <span class="field-hint">Optional: Natural, Polished, Honed, Calibrated, etc.</span>
          </div>

          <div class="form-group">
            <label for="usage">Usage</label>
            <input type="text" id="usage" placeholder="Enter usage">
            <span class="field-hint">Optional: Flooring, Wall Cladding, Countertops, etc.</span>
          </div>
        </div>

        <!-- ===== Technical Specifications Section ===== -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-flask"></i> Technical Specifications</h3>
          
          <div class="form-group">
            <label for="water_absorption">Water Absorption</label>
            <input type="text" id="water_absorption" placeholder="Enter water absorption">
            <span class="field-hint">Optional: 2-3%, 0.5-1%, etc.</span>
          </div>

          <div class="form-group">
            <label for="density">Density</label>
            <input type="text" id="density" placeholder="Enter density">
            <span class="field-hint">Optional: 2.4-2.6 g/cm³, 2.7-2.9 g/cm³, etc.</span>
          </div>

          <div class="form-group">
            <label for="compressive_strength">Compressive Strength</label>
            <input type="text" id="compressive_strength" placeholder="Enter compressive strength">
            <span class="field-hint">Optional: 1800-2200 kg/cm², 2500-3000 kg/cm², etc.</span>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" placeholder="Enter product description" rows="4"></textarea>
            <span class="field-hint">Optional: Detailed description about the stone product</span>
          </div>
        </div>

        <!-- ===== Pricing Section ===== -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-tag"></i> Pricing</h3>
          
          <div class="form-group">
            <label for="price">Price</label>
            <input type="number" id="price" placeholder="Enter price">
            <span class="field-hint">Optional: Price of the product</span>
          </div>

          <div class="form-group">
            <label for="price_unit">Unit</label>
            <input type="text" id="price_unit" placeholder="Enter unit (sqft/piece/kg)">
            <span class="field-hint">Optional: sqft, piece, kg, ton, etc.</span>
          </div>
        </div>

        <!-- ===== Contact Information Section ===== -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-address-card"></i> Contact Information</h3>
          
          <div class="form-group">
            <label for="contact_country_code" class="required">Country Code</label>
            <div class="phone-input-container">
              <span class="country-code-prefix">+</span>
              <input type="text" id="contact_country_code" class="country-code-input" placeholder="91" value="91" required maxlength="4">
            </div>
            <span class="field-hint">Enter country code without + (e.g., 91 for India)</span>
          </div>

          <div class="form-group">
            <label for="contact_number" class="required">Mobile Number</label>
            <div class="phone-input-container">
              <span class="phone-prefix">+<span id="country-code-display">91</span></span>
              <input type="text" id="contact_number" class="phone-input" placeholder="Mobile Number" required maxlength="10">
            </div>
            <span class="field-hint">Enter 10-digit mobile number without country code</span>
          </div>

          <div class="form-group">
            <label for="email" class="required">Email Address</label>
            <input type="email" id="email" placeholder="Enter email address" required>
            <span class="field-hint">Your business email address</span>
          </div>

          <div class="form-group">
            <label for="factory_name" class="required">Company / Factory Name</label>
            <input type="text" id="factory_name" placeholder="Enter company/factory name" required>
            <span class="field-hint">Name of your business or factory</span>
          </div>

          <div class="form-group">
            <label for="address" class="required">Address</label>
            <input type="text" id="address" placeholder="Enter complete address" required>
            <span class="field-hint">Complete business address</span>
          </div>

          <div class="form-group">
            <label for="gst_number">GST Number</label>
            <input type="text" id="gst_number" placeholder="Enter GST number">
            <span class="field-hint">Optional: Your business GST number</span>
          </div>
        </div>

        <!-- ===== Additional Fields Section ===== -->
        <div class="additional-fields-section">
          <h3 class="section-title"><i class="fas fa-plus-circle"></i> Additional Information</h3>
          <span class="field-hint">Add any extra fields you want to include in your product listing</span>
          
          <div id="additional-fields-container">
            <!-- Additional fields will be added here dynamically -->
          </div>
          
          <button type="button" class="add-field-btn" id="add-field-btn">
            <i class="fas fa-plus"></i> Add Custom Field
          </button>
        </div>

        <!-- ===== Image Upload Section ===== -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-images"></i> Product Images</h3>
          
          <div class="form-group">
            <label class="required">Upload Product Images</label>
            <div class="image-upload-section">
              <div class="upload-options">
                <div class="upload-btn" onclick="document.getElementById('imageInput').click()">
                  <i class="fas fa-folder-open"></i> Choose from Gallery
                </div>
                <div class="upload-btn" id="cancel-upload">
                  <i class="fas fa-times"></i> Clear All Images
                </div>
              </div>
              <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
              <small class="field-hint">Select multiple images (max 10) - At least one image is required.</small>
              <div class="preview" id="preview"></div>
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submit-btn">
          <i class="fas fa-save"></i> Save Product
        </button>
      </form>
    </div>
  </div>

  <!-- ===== Footer ===== -->
  <footer>
    &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services
  </footer>
</div>

<!-- ===== Processing Overlay ===== -->
<div class="processing-overlay" id="processing-overlay">
  <div class="processing-content">
    <div class="processing-spinner"></div>
    <div class="processing-text">Processing Your Product</div>
    <div class="processing-subtext">Please wait while we save your product details...</div>
  </div>
</div>

<script type="module">
// Firebase imports
import { 
  db, 
  auth,
  collection, 
  addDoc, 
  doc, 
  updateDoc, 
  serverTimestamp,
  signOut,
  onAuthStateChanged
} from './firebase-config.js';

/* ===== Global Variables ===== */
let imagesBase64 = [];
let additionalFieldsCount = 0;

/* ===== Additional Fields Functionality ===== */
document.getElementById('add-field-btn').addEventListener('click', addAdditionalField);

function addAdditionalField() {
  additionalFieldsCount++;
  const container = document.getElementById('additional-fields-container');
  const fieldId = 'additional_field_' + additionalFieldsCount;
  
  const fieldHTML = `
    <div class="additional-field" id="${fieldId}">
      <div class="field-input">
        <label>Field Name</label>
        <input type="text" placeholder="Enter field name" class="additional-field-name">
      </div>
      <div class="field-input">
        <label>Field Value</label>
        <input type="text" placeholder="Enter field value" class="additional-field-value">
      </div>
      <button type="button" class="remove-field-btn" onclick="removeAdditionalField('${fieldId}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', fieldHTML);
}

function removeAdditionalField(fieldId) {
  const field = document.getElementById(fieldId);
  if (field) {
    field.remove();
  }
}

// Get additional fields data
function getAdditionalFieldsData() {
  const fields = [];
  const fieldElements = document.querySelectorAll('.additional-field');
  
  fieldElements.forEach(field => {
    const nameInput = field.querySelector('.additional-field-name');
    const valueInput = field.querySelector('.additional-field-value');
    
    if (nameInput.value.trim() && valueInput.value.trim()) {
      fields.push({
        name: nameInput.value.trim(),
        value: valueInput.value.trim()
      });
    }
  });
  
  return fields;
}

/* ===== Image Upload Functionality ===== */
// Add image to preview
function addImageToPreview(imageDataUrl) {
  const preview = document.getElementById('preview');
  const imageId = 'img_' + Date.now();
  
  const previewItem = document.createElement('div');
  previewItem.className = 'preview-item';
  previewItem.id = imageId;
  previewItem.innerHTML = `
    <img src="${imageDataUrl}" alt="Product Image">
    <button type="button" class="remove-image" onclick="removeImage('${imageId}')">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  preview.appendChild(previewItem);
  imagesBase64.push(imageDataUrl);
  updateFileInput();
}

// Remove image from preview
function removeImage(imageId) {
  const previewItem = document.getElementById(imageId);
  if (previewItem) {
    const img = previewItem.querySelector('img');
    const imgSrc = img.src;
    
    const index = imagesBase64.findIndex(image => image === imgSrc);
    if (index > -1) {
      imagesBase64.splice(index, 1);
    }
    
    previewItem.remove();
    
    if (imagesBase64.length === 0) {
      document.getElementById('imageInput').value = '';
    }
  }
}

// Cancel Upload Button Functionality
document.getElementById('cancel-upload').addEventListener('click', function() {
  document.getElementById('imageInput').value = '';
  document.getElementById('preview').innerHTML = '';
  imagesBase64 = [];
  updateFileInput();
});

// Update file input for validation
function updateFileInput() {
  const fileInput = document.getElementById('imageInput');
  if (imagesBase64.length > 0) {
    fileInput.setCustomValidity('');
  } else {
    fileInput.setCustomValidity('Please select at least one image');
  }
}

/* ===== Validation Functions ===== */
function validatePhoneNumber(input) {
  input.value = input.value.replace(/\D/g, '');
  if (input.value.length > 10) {
    input.value = input.value.slice(0, 10);
  }
}

function validateCountryCode(input) {
  input.value = input.value.replace(/\D/g, '');
  if (input.value.length > 4) {
    input.value = input.value.slice(0, 4);
  }
  // Update displayed country code
  document.getElementById('country-code-display').textContent = input.value || '91';
}

// Update country code display when input changes
document.getElementById('contact_country_code').addEventListener('input', function() {
  document.getElementById('country-code-display').textContent = this.value || '91';
});

/* ===== Auth Functions ===== */
const btnSignOut = document.getElementById('btn-signout');
const userAvatar = document.getElementById('user-avatar');
const userName = document.getElementById('user-name');

// Sign Out
btnSignOut.addEventListener('click', async () => { 
  await signOut(auth); 
  alert('Signed out successfully'); 
});

// Auth state listener
onAuthStateChanged(auth, (user) => {
  if (user) {
    btnSignOut.style.display = 'inline-block';
    
    const displayName = user.displayName || 'User';
    userName.textContent = displayName;
    userAvatar.textContent = displayName.charAt(0).toUpperCase();
  } else {
    btnSignOut.style.display = 'none';
    userName.textContent = 'Guest User';
    userAvatar.textContent = 'G';
    // Redirect to login if not authenticated
    window.location.href = 'index.html';
  }
});

/* ===== Image Upload to Worker ===== */
async function uploadImages() {
  let urls = [];

  for (let img of imagesBase64) {
    try {
      const res = await fetch("https://mute-frost-eefa.ravijain236129.workers.dev", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ base64: img })
      });

      const out = await res.json();
      if (out.status === "success") urls.push(out.url);

    } catch (e) {
      console.error("Upload Error:", e);
    }
  }
  return urls;
}

/* ===== Product Form Logic ===== */
const form = document.getElementById("product-form");
const productIdInput = document.getElementById("product-id");
const preview = document.getElementById("preview");
const imageInput = document.getElementById("imageInput");
const submitBtn = document.getElementById("submit-btn");
const processingOverlay = document.getElementById("processing-overlay");

// Handle file input changes
imageInput.addEventListener("change", () => {
  const files = Array.from(imageInput.files).slice(0, 10 - imagesBase64.length);

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (event) => {
      addImageToPreview(event.target.result);
    };
    reader.readAsDataURL(file);
  });
});

/* EDIT MODE - FOR MY HISTORY PAGE */
window.addEventListener("DOMContentLoaded", () => {
  const editId = localStorage.getItem("editProductId");
  const editData = localStorage.getItem("editProductData");

  if (editId && editData) {
    const p = JSON.parse(decodeURIComponent(editData));

    productIdInput.value = editId;
    form.category.value = p.category || "";
    form.stone_name.value = p.stone_name || "";
    form.sub_category.value = p.sub_category || "";
    form.type.value = p.type || "";
    form.color.value = p.color || "";
    form.thickness.value = p.thickness || "";
    form.size.value = p.size || "";
    form.finish.value = p.finish || "";
    form.usage.value = p.usage || "";
    form.water_absorption.value = p.water_absorption || "";
    form.density.value = p.density || "";
    form.compressive_strength.value = p.compressive_strength || "";
    form.description.value = p.description || "";
    form.price.value = p.price || "";
    form.price_unit.value = p.price_unit || "";
    
    // Handle phone number and country code
    let phoneNumber = p.contact_number || "";
    let countryCode = "91"; // default
    
    if (phoneNumber.startsWith('+')) {
      const parts = phoneNumber.split(' ');
      if (parts.length > 1) {
        countryCode = parts[0].substring(1); // Remove +
        phoneNumber = parts[1];
      }
    }
    
    form.contact_country_code.value = countryCode;
    document.getElementById('country-code-display').textContent = countryCode;
    form.contact_number.value = phoneNumber;
    
    form.email.value = p.email || "";
    form.factory_name.value = p.factory_name || "";
    form.address.value = p.address || "";
    form.gst_number.value = p.gst_number || "";

    // Load additional fields
    if (p.additional_fields && p.additional_fields.length) {
      p.additional_fields.forEach(field => {
        addAdditionalField();
        const lastField = document.querySelector('.additional-field:last-child');
        if (lastField) {
          lastField.querySelector('.additional-field-name').value = field.name;
          lastField.querySelector('.additional-field-value').value = field.value;
        }
      });
    }

    // Show existing images
    if (p.images && p.images.length) {
      imagesBase64 = [];
      p.images.forEach(img => {
        addImageToPreview(img);
      });
    }
  }
});

/* AUTH CHECK */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location = "index.html";
  }
});

/* SAVE / UPDATE PRODUCT */
form.onsubmit = async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return alert("Login required");

  // Validate images
  if (imagesBase64.length === 0) {
    alert("Please add at least one product image");
    return;
  }

  // Validate phone number
  const phoneNumber = form.contact_number.value.trim();
  if (phoneNumber.length !== 10) {
    alert("Please enter a valid 10-digit mobile number");
    return;
  }

  // Validate country code
  const countryCode = form.contact_country_code.value.trim();
  if (!countryCode) {
    alert("Please enter a valid country code");
    return;
  }

  // Show processing overlay
  processingOverlay.classList.add('active');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

  try {
    // Upload images
    let imageUrls = await uploadImages();

    const data = {
      // Basic Information
      category: form.category.value,
      stone_name: form.stone_name.value,
      sub_category: form.sub_category.value,
      
      // Product Details
      type: form.type.value,
      color: form.color.value,
      thickness: form.thickness.value,
      size: form.size.value,
      finish: form.finish.value,
      usage: form.usage.value,
      
      // Technical Specifications
      water_absorption: form.water_absorption.value,
      density: form.density.value,
      compressive_strength: form.compressive_strength.value,
      description: form.description.value,
      
      // Pricing
      price: form.price.value ? parseFloat(form.price.value) : "",
      price_unit: form.price_unit.value,
      
      // Contact Information
      contact_number: "+" + countryCode + " " + phoneNumber,
      email: form.email.value,
      factory_name: form.factory_name.value,
      address: form.address.value,
      gst_number: form.gst_number.value,
      
      // Additional Fields
      additional_fields: getAdditionalFieldsData(),
      
      // System Fields
      images: imageUrls,
      status: "active", // Product active status for your website
      created_at: serverTimestamp(),
      userId: user.uid
    };

    const id = productIdInput.value;

    if (id) {
      await updateDoc(doc(db, "products", id), data);
    } else {
      await addDoc(collection(db, "products"), data);
    }

    // Hide processing overlay
    processingOverlay.classList.remove('active');
    
    // Show success message
    alert(id ? "Product updated successfully!" : "Product added successfully!");

    // Reset form
    form.reset();
    preview.innerHTML = "";
    imageInput.value = "";
    imagesBase64 = [];
    productIdInput.value = "";
    document.getElementById('additional-fields-container').innerHTML = "";
    additionalFieldsCount = 0;
    
    // Reset country code to default
    form.contact_country_code.value = "91";
    document.getElementById('country-code-display').textContent = "91";

  } catch (err) {
    // Hide processing overlay on error
    processingOverlay.classList.remove('active');
    alert("Error: " + err.message);
  } finally {
    // Reset submit button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Product';
  }
};

// Make functions available globally for onclick events
window.removeImage = removeImage;
window.removeAdditionalField = removeAdditionalField;
window.validatePhoneNumber = validatePhoneNumber;
window.validateCountryCode = validateCountryCode;
</script>

</body>
</html>
