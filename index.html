<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Sync - Rajasthan Stones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
            color: #333;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        
        .header { 
            background: linear-gradient(135deg, #c7a97b 0%, #b8945c 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }
        
        .header h1 { 
            font-size: 2.5rem; 
            margin-bottom: 10px; 
            position: relative;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .header p {
            position: relative;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content { 
            padding: 30px; 
        }
        
        .back-link { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            color: #c7a97b; 
            text-decoration: none; 
            font-weight: 600; 
            margin-bottom: 20px; 
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 5px;
        }
        
        .back-link:hover {
            background: rgba(199, 169, 123, 0.1);
            transform: translateX(-5px);
        }
        
        .notification { 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
            display: block; 
        }
        
        .notification.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
            display: block; 
        }
        
        .notification.warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
            display: block; 
        }
        
        .setup-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 10px; 
            margin-bottom: 30px; 
            border-left: 5px solid #c7a97b;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .setup-section:hover {
            transform: translateY(-5px);
        }
        
        .setup-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }
        
        .config-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #c7a97b;
            box-shadow: 0 0 0 3px rgba(199, 169, 123, 0.2);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: #c7a97b;
            color: white;
            align-self: flex-start;
        }
        
        .btn-primary:hover {
            background: #b8945c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(199, 169, 123, 0.3);
        }
        
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-danger { 
            background: #dc3545; 
            color: white; 
        }
        
        .btn-info { 
            background: #17a2b8; 
            color: white; 
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .action-buttons { 
            display: flex; 
            gap: 15px; 
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .products-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 25px; 
            margin-top: 20px; 
        }
        
        .product-card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
            border: 1px solid #e0e0e0; 
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .product-image { 
            width: 100%; 
            height: 200px; 
            object-fit: cover; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            background: #f5f5f5;
        }
        
        .product-name {
            font-weight: 600; 
            margin-bottom: 10px; 
            font-size: 1.1rem;
            color: #333;
            line-height: 1.3;
        }
        
        .product-details {
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-size: 0.9rem; 
            color: #666;
        }
        
        .product-price {
            font-weight: 600;
            color: #c7a97b;
        }
        
        .facebook-status { 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 600; 
            text-align: center; 
            margin-top: 10px; 
        }
        
        .status-posted { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .status-not-posted { 
            background: #fff3cd; 
            color: #856404; 
        }
        
        .card-action-buttons { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
            margin-top: auto;
        }
        
        .loading { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            padding: 40px; 
            color: #666; 
            grid-column: 1 / -1;
        }
        
        .loading::after { 
            content: ''; 
            width: 20px; 
            height: 20px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #c7a97b; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* Troubleshooting Section */
        .troubleshooting {
            background: #e7f3ff;
            border-left: 5px solid #17a2b8;
        }
        
        .troubleshooting-list {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .troubleshooting-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .permission-list {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .permission-list h4 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .setup-section {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Additional styling for better visual hierarchy */
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }
        
        .section-title i {
            color: #c7a97b;
        }
        
        .config-help {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #c7a97b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fab fa-facebook"></i> Facebook Sync</h1>
            <p>Auto-posting to your Facebook Page</p>
        </div>

        <div class="content">
            <a href="admin.html" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Admin Panel
            </a>

            <div id="notification" class="notification"></div>

            <!-- Stats Overview -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-products">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="posted-products">0</div>
                    <div class="stat-label">Posted to Facebook</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-products">0</div>
                    <div class="stat-label">Pending Posts</div>
                </div>
            </div>

            <!-- Configuration Display -->
            <div class="setup-section">
                <h2><i class="fas fa-check-circle"></i> Facebook Configuration</h2>
                <div class="config-form">
                    <div class="form-group">
                        <label for="page-access-token">Facebook Page Access Token</label>
                        <input type="text" id="page-access-token" placeholder="EAAxxxxxxxx..." value="">
                        <div class="config-help">Get this from Facebook Graph API Explorer with proper permissions</div>
                    </div>
                    <div class="form-group">
                        <label for="page-id">Facebook Page ID</label>
                        <input type="text" id="page-id" placeholder="123456789012345" value="">
                        <div class="config-help">Your Facebook Page ID (numeric)</div>
                    </div>
                    <button class="btn btn-primary" onclick="saveFacebookConfig()">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>
            </div>

            <!-- Troubleshooting Section -->
            <div class="setup-section troubleshooting">
                <h2><i class="fas fa-tools"></i> Troubleshooting 403 Errors</h2>
                <p><strong>Common causes of 403 errors:</strong></p>
                <ul class="troubleshooting-list">
                    <li>Expired or invalid access token</li>
                    <li>Missing required permissions</li>
                    <li>Page not published</li>
                    <li>App not approved by Facebook</li>
                    <li>Token doesn't have page posting permissions</li>
                </ul>
                
                <div class="permission-list">
                    <h4>Required Permissions:</h4>
                    <ul>
                        <li><strong>pages_show_list</strong> - To see your pages</li>
                        <li><strong>pages_read_engagement</strong> - Basic page access</li>
                        <li><strong>pages_manage_posts</strong> - To create posts</li>
                        <li><strong>pages_read_user_content</strong> - To read page content</li>
                    </ul>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="debugToken()">
                        <i class="fas fa-bug"></i> Debug Access Token
                    </button>
                    <button class="btn btn-info" onclick="showTokenHelp()">
                        <i class="fas fa-question-circle"></i> How to Get Token
                    </button>
                </div>
                
                <div id="debug-info" class="debug-info"></div>
            </div>

            <!-- Products Management -->
            <div class="setup-section">
                <h2><i class="fas fa-cubes"></i> Manage Products</h2>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="syncAllProducts()">
                        <i class="fas fa-sync-alt"></i> Sync All to Facebook
                    </button>
                    <button class="btn btn-info" onclick="testFacebookConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button class="btn btn-primary" onclick="loadProducts()">
                        <i class="fas fa-redo"></i> Refresh Products
                    </button>
                </div>

                <div id="products-container" class="products-grid">
                    <div class="loading">Loading products...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { 
            db, 
            collection, 
            getDocs, 
            doc, 
            updateDoc,
            serverTimestamp
        } from './firebase-config.js';

        let products = [];
        let facebookConfig = {};

        // Load Facebook configuration
        function loadFacebookConfig() {
            const savedConfig = localStorage.getItem('facebookConfig');
            if (savedConfig) {
                facebookConfig = JSON.parse(savedConfig);
                document.getElementById('page-access-token').value = facebookConfig.pageAccessToken || '';
                document.getElementById('page-id').value = facebookConfig.pageId || '';
                showNotification('‚úÖ Facebook configuration loaded!', 'success');
            }
        }

        // Save Facebook configuration
        window.saveFacebookConfig = function() {
            const pageAccessToken = document.getElementById('page-access-token').value.trim();
            const pageId = document.getElementById('page-id').value.trim();

            if (!pageAccessToken || !pageId) {
                showNotification('Please fill all Facebook configuration fields', 'error');
                return;
            }

            facebookConfig = { pageAccessToken, pageId };
            localStorage.setItem('facebookConfig', JSON.stringify(facebookConfig));
            showNotification('‚úÖ Facebook configuration saved successfully!', 'success');
        }

        // Load products from Firestore
        async function loadProducts() {
            try {
                showNotification('Loading products...', 'success');
                
                const querySnapshot = await getDocs(collection(db, "products"));
                products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                renderProducts();
                updateStats();
                showNotification('‚úÖ Products loaded successfully!', 'success');
            } catch (error) {
                showNotification('Error loading products: ' + error.message, 'error');
            }
        }

        // Update statistics
        function updateStats() {
            const totalProducts = products.length;
            const postedProducts = products.filter(p => p.posted_to_facebook).length;
            const pendingProducts = totalProducts - postedProducts;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('posted-products').textContent = postedProducts;
            document.getElementById('pending-products').textContent = pendingProducts;
        }

        // Render products
        function renderProducts() {
            const container = document.getElementById('products-container');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="loading">No products found</div>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <img src="${product.images && product.images[0] ? product.images[0] : 'https://via.placeholder.com/300x200?text=Stone+Image'}" 
                         alt="${product.stone_name}" class="product-image">
                    <div class="product-name">${product.stone_name}</div>
                    <div class="product-details">
                        <span class="product-price">‚Çπ${product.price || 'N/A'} ${product.price_unit || ''}</span>
                        <span>${product.category || ''}</span>
                    </div>
                    <div class="facebook-status ${product.posted_to_facebook ? 'status-posted' : 'status-not-posted'}">
                        ${product.posted_to_facebook ? '‚úÖ Posted to Facebook' : '‚è≥ Not Posted'}
                    </div>
                    <div class="card-action-buttons">
                        <button class="btn btn-success" onclick="postSingleProduct('${product.id}')">
                            <i class="fab fa-facebook"></i> Post to Facebook
                        </button>
                        ${product.posted_to_facebook && product.facebook_post_url ? `
                        <button class="btn btn-info" onclick="viewPost('${product.facebook_post_url}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Post single product to Facebook
        window.postSingleProduct = async function(productId) {
            if (!facebookConfig.pageAccessToken) {
                showNotification('Please configure Facebook first', 'error');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) return;

            try {
                showNotification('Posting to Facebook...', 'success');
                
                // Post to Facebook using Graph API
                const result = await postToFacebook(product);
                
                if (result.success) {
                    // Update the product in Firestore
                    await updateDoc(doc(db, "products", productId), {
                        posted_to_facebook: true,
                        facebook_post_id: result.post_id,
                        facebook_post_url: result.post_url,
                        posted_at: serverTimestamp()
                    });

                    // Reload products to reflect changes
                    await loadProducts();
                    showNotification('‚úÖ Posted to Facebook successfully!', 'success');
                } else {
                    showNotification('‚ùå Facebook Error: ' + result.error, 'error');
                }

            } catch (error) {
                showNotification('‚ùå Network Error: ' + error.message, 'error');
            }
        }

        // Sync all products
        window.syncAllProducts = async function() {
            if (!facebookConfig.pageAccessToken) {
                showNotification('Please configure Facebook first', 'error');
                return;
            }

            const notPostedProducts = products.filter(p => !p.posted_to_facebook);
            
            if (notPostedProducts.length === 0) {
                showNotification('All products are already posted to Facebook!', 'success');
                return;
            }

            showNotification(`Posting ${notPostedProducts.length} products to Facebook...`, 'success');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let product of notPostedProducts) {
                try {
                    const result = await postToFacebook(product);
                    if (result.success) {
                        await updateDoc(doc(db, "products", product.id), {
                            posted_to_facebook: true,
                            facebook_post_id: result.post_id,
                            facebook_post_url: result.post_url,
                            posted_at: serverTimestamp()
                        });
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Facebook API Error:', result.error);
                    }
                    // Add delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 3000));
                } catch (error) {
                    errorCount++;
                    console.error('Network Error:', error);
                }
            }
            
            // Reload products to reflect changes
            await loadProducts();
            
            if (errorCount > 0) {
                showNotification(`‚úÖ ${successCount} posted, ‚ùå ${errorCount} failed. Check console for details.`, 'warning');
            } else {
                showNotification(`‚úÖ ${successCount} products posted successfully!`, 'success');
            }
        }

        // Test Facebook connection
        window.testFacebookConnection = async function() {
            if (!facebookConfig.pageAccessToken) {
                showNotification('Please configure Facebook first', 'error');
                return;
            }

            try {
                showNotification('Testing Facebook connection...', 'success');
                const response = await fetch(`https://graph.facebook.com/v18.0/${facebookConfig.pageId}?fields=name,access_token&access_token=${facebookConfig.pageAccessToken}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.name) {
                    showNotification(`‚úÖ Connected to Facebook Page: ${result.name}`, 'success');
                } else if (result.error) {
                    showNotification(`‚ùå Facebook API Error: ${result.error.message}`, 'error');
                } else {
                    showNotification('‚ùå Connection failed: Unknown error', 'error');
                }
            } catch (error) {
                showNotification('‚ùå Connection error: ' + error.message, 'error');
            }
        }

        // Debug access token
        window.debugToken = async function() {
            if (!facebookConfig.pageAccessToken) {
                showNotification('Please enter an access token first', 'error');
                return;
            }

            try {
                showNotification('Debugging access token...', 'success');
                const debugResponse = await fetch(`https://graph.facebook.com/debug_token?input_token=${facebookConfig.pageAccessToken}&access_token=${facebookConfig.pageAccessToken}`);
                
                if (!debugResponse.ok) {
                    throw new Error(`HTTP ${debugResponse.status}`);
                }
                
                const debugResult = await debugResponse.json();
                
                const debugInfo = document.getElementById('debug-info');
                debugInfo.innerHTML = `
                    <strong>Token Debug Info:</strong><br>
                    - Valid: ${debugResult.data?.is_valid ? '‚úÖ Yes' : '‚ùå No'}<br>
                    - User ID: ${debugResult.data?.user_id || 'N/A'}<br>
                    - App ID: ${debugResult.data?.app_id || 'N/A'}<br>
                    - Expires: ${debugResult.data?.expires_at ? new Date(debugResult.data.expires_at * 1000).toLocaleString() : 'N/A'}<br>
                    - Scopes: ${debugResult.data?.scopes ? debugResult.data.scopes.join(', ') : 'N/A'}
                `;
                debugInfo.style.display = 'block';
                
            } catch (error) {
                showNotification('‚ùå Debug failed: ' + error.message, 'error');
            }
        }

        // Show token help
        window.showTokenHelp = function() {
            const helpMessage = `
                How to get a Facebook Page Access Token:

                1. Go to https://developers.facebook.com/tools/explorer/
                2. Select your app from the top dropdown
                3. Click "Generate Access Token"
                4. Add these permissions:
                   - pages_show_list
                   - pages_read_engagement  
                   - pages_manage_posts
                   - pages_read_user_content
                5. Generate the token
                6. Click "Open in Access Token Tool" to make it permanent
                7. Copy the token and paste it above

                Make sure your Facebook App is in "Live" mode and approved for these permissions.
            `;
            showNotification(helpMessage, 'warning');
        }

        // Post to Facebook function with better error handling
        async function postToFacebook(product) {
            try {
                const pageAccessToken = facebookConfig.pageAccessToken;
                const pageId = facebookConfig.pageId;
                
                if (!pageAccessToken || !pageId) {
                    return {
                        success: false,
                        error: 'Missing Facebook configuration'
                    };
                }

                // Create the message for Facebook post
                const message = `
${product.stone_name}

üí∞ Price: ‚Çπ${product.price || 'N/A'} ${product.price_unit || ''}
üì¶ Category: ${product.category || 'N/A'}

${product.description || 'Premium quality natural stone from Rajasthan'}

#RajasthanStones #NaturalStone #${(product.category || 'Stone').replace(/\s+/g, '')} #${product.stone_name.replace(/\s+/g, '')}
                `.trim();

                // Prepare the post data
                const postData = {
                    message: message,
                    access_token: pageAccessToken
                };

                // If product has images, include the first one
                if (product.images && product.images[0]) {
                    postData.url = product.images[0];
                }

                console.log('Posting to Facebook:', { pageId, postData });

                // Make the API request to Facebook
                const response = await fetch(`https://graph.facebook.com/v18.0/${pageId}/feed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                });

                const result = await response.json();

                console.log('Facebook API Response:', result);

                if (result.id) {
                    const postId = result.id;
                    const postUrl = `https://www.facebook.com/${postId.replace('_', '/posts/')}`;
                    
                    return {
                        success: true,
                        post_id: postId,
                        post_url: postUrl
                    };
                } else {
                    let errorMessage = 'Unknown error';
                    if (result.error) {
                        errorMessage = `[${result.error.code}] ${result.error.message}`;
                        if (result.error.error_user_msg) {
                            errorMessage += ` - ${result.error.error_user_msg}`;
                        }
                    }
                    return {
                        success: false,
                        error: errorMessage
                    };
                }
            } catch (error) {
                console.error('Facebook posting error:', error);
                return {
                    success: false,
                    error: `Network error: ${error.message}`
                };
            }
        }

        // View post
        window.viewPost = function(postUrl) {
            window.open(postUrl, '_blank');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Auto-hide success notifications after 8 seconds, warnings after 10 seconds
            if (type === 'success') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 8000);
            } else if (type === 'warning') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 10000);
            }
        }

        // Initialize
        loadFacebookConfig();
        loadProducts();
    </script>
</body>
</html>
