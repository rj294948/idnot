<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERMANENT FACEBOOK FIX</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #0f172a; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(135deg, #dc2626, #ea580c, #d97706); color: white; padding: 40px; border-radius: 15px; text-align: center; margin-bottom: 30px; }
        .btn { padding: 18px 30px; border: none; border-radius: 12px; cursor: pointer; margin: 10px; font-weight: bold; font-size: 18px; transition: all 0.3s; }
        .btn-success { background: linear-gradient(135deg, #16a34a, #22c55e); color: white; }
        .btn-primary { background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; }
        .btn-warning { background: linear-gradient(135deg, #d97706, #f59e0b); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .notification { padding: 20px; margin: 20px 0; border-radius: 12px; font-weight: bold; font-size: 16px; line-height: 1.6; }
        .success { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border: 3px solid #16a34a; }
        .error { background: linear-gradient(135deg, #fecaca, #fca5a5); color: #991b1b; border: 3px solid #dc2626; }
        .warning { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 3px solid #d97706; }
        .section { background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 30px; border-radius: 15px; margin: 25px 0; border-left: 6px solid #3b82f6; }
        textarea, input { width: 100%; padding: 18px; border: 3px solid #e2e8f0; border-radius: 10px; margin: 12px 0; font-size: 18px; background: white; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; margin-top: 30px; }
        .product-card { border: 3px solid #e2e8f0; padding: 25px; border-radius: 15px; background: white; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: all 0.3s; }
        .product-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .product-image { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 20px; border: 3px solid #e2e8f0; }
        .solution-section { background: linear-gradient(135deg, #fffbeb, #fed7aa); border-left: 6px solid #d97706; }
        .token-section { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 6px solid #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 3rem; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üî¥ PERMANENT 403 ERROR FIX</h1>
            <p style="font-size: 1.5rem; opacity: 0.9;">RJ Multi Stone Hub - ULTIMATE SOLUTION</p>
        </div>

        <div id="notification"></div>

        <!-- PERMANENT SOLUTION SECTION -->
        <div class="section solution-section">
            <h2 style="color: #dc2626; font-size: 2rem; margin-bottom: 20px;">üéØ PERMANENT FIX INSTRUCTIONS</h2>
            
            <div style="background: white; padding: 25px; border-radius: 12px; margin: 20px 0; border: 3px solid #d97706;">
                <h3 style="color: #dc2626; margin-bottom: 15px;">üö® STEP-BY-STEP SOLUTION:</h3>
                <ol style="font-size: 18px; line-height: 2; margin-left: 20px;">
                    <li><strong>Go to:</strong> <a href="https://developers.facebook.com/apps/865642029139626/dashboard/" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: bold;">Your Facebook App Dashboard</a></li>
                    <li><strong>Click:</strong> "App Review" ‚Üí "Permissions and Features"</li>
                    <li><strong>Find:</strong> "pages_manage_posts" and "pages_read_engagement"</li>
                    <li><strong>Click:</strong> "Request Advanced Access" for both</li>
                    <li><strong>Submit:</strong> Use case: "Auto-post products to my business page"</li>
                    <li><strong>Switch:</strong> App Mode from "Development" to "Live"</li>
                    <li><strong>Generate:</strong> NEW Page Access Token</li>
                </ol>
            </div>

            <button class="btn btn-warning" onclick="openAppDashboard()" style="font-size: 20px; padding: 20px 35px;">
                üîß OPEN APP DASHBOARD
            </button>
        </div>

        <!-- TOKEN GENERATION WITH DEBUG -->
        <div class="section token-section">
            <h2 style="color: #2563eb; font-size: 2rem; margin-bottom: 20px;">üîë TOKEN GENERATION & DEBUG</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4>User Token (Current):</h4>
                    <textarea id="user-token" rows="3" style="background: #fff; border: 3px solid #3b82f6; font-family: monospace;">EAAMTSZC2mRqoBQCzLMsDjZCk4QkwpoSKqZAkMGYsqzrJFgOdJ8rfSOGcv5kPZAOrECpvxbXU0affIpaGtcaY9lzEtQzi3D4NJpgZBanlosRTFISDrYIe80rArsZBTIXNYLV3dtsLZCZCkgaSzs0iQZAG31k0s4l7oeDpAB50ZB2380poa5fjZBabStPZBLUBZB7j4sLtWxeH95mb6kztuiZBDZAoeREUNw6zRkNintUpWe2</textarea>
                </div>
                <div>
                    <h4>Page Token (New):</h4>
                    <textarea id="page-token" rows="3" style="background: #fff; border: 3px solid #10b981; font-family: monospace;" placeholder="NEW PAGE TOKEN WILL APPEAR HERE"></textarea>
                </div>
            </div>

            <input type="text" id="page-id" value="950920808095297" placeholder="Page ID" style="font-size: 18px; font-weight: bold;">

            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn btn-primary" onclick="generateAndDebugToken()">
                    üêõ GENERATE & DEBUG TOKEN
                </button>
                <button class="btn btn-success" onclick="saveFinalConfig()">
                    üíæ SAVE FINAL CONFIG
                </button>
                <button class="btn btn-warning" onclick="testFinalConnection()">
                    üîó TEST FINAL CONNECTION
                </button>
            </div>

            <div id="debug-result" style="margin-top: 20px;"></div>
        </div>

        <!-- ULTIMATE POSTING -->
        <div class="section">
            <h2 style="color: #16a34a; font-size: 2rem; margin-bottom: 20px;">üöÄ ULTIMATE POSTING SOLUTION</h2>
            
            <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 25px; border-radius: 12px; margin: 20px 0; border: 3px solid #16a34a;">
                <h3 style="color: #166534;">‚úÖ GUARANTEED TO WORK AFTER:</h3>
                <ul style="font-size: 18px; line-height: 1.8; margin-left: 20px;">
                    <li>App is in <strong>LIVE MODE</strong></li>
                    <li><strong>pages_manage_posts</strong> permission approved</li>
                    <li>Using <strong>NEW Page Token</strong> (not old token)</li>
                </ul>
            </div>

            <button class="btn btn-success" onclick="ultimateFinalPost()" style="font-size: 22px; padding: 25px 40px; background: linear-gradient(135deg, #16a34a, #22c55e, #4ade80);">
                üöÄ ULTIMATE FINAL AUTO POST
            </button>
        </div>

        <!-- PRODUCTS -->
        <div id="products-container">
            <div style="text-align: center; padding: 50px; color: #666; font-size: 20px;">
                <div style="font-size: 60px; margin-bottom: 20px;">‚è≥</div>
                <h3>Loading products from Firestore...</h3>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            db, 
            collection, 
            getDocs, 
            doc, 
            updateDoc,
            serverTimestamp
        } from './firebase-config.js';

        let products = [];
        let config = {};

        // Load configuration
        function loadConfig() {
            const saved = localStorage.getItem('finalConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('page-token').value = config.token || '';
                document.getElementById('page-id').value = config.pageId || '950920808095297';
            }
        }

        // Open App Dashboard
        window.openAppDashboard = function() {
            window.open('https://developers.facebook.com/apps/865642029139626/dashboard/', '_blank');
            showNotification('üîß Opening your App Dashboard... Complete the steps mentioned above.', 'warning');
        }

        // Generate and Debug Token
        window.generateAndDebugToken = async function() {
            const userToken = document.getElementById('user-token').value.trim();
            
            if (!userToken) {
                showNotification('‚ùå Please enter User Token', 'error');
                return;
            }

            try {
                showNotification('üîÑ Generating Page Token and Debugging...', 'warning');
                
                // Get pages
                const response = await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${userToken}`);
                const result = await response.json();

                console.log('Pages Response:', result);

                if (result.data && result.data.length > 0) {
                    // Auto-select RJ Multi Stone Hub page
                    const targetPage = result.data.find(page => page.id === '950920808095297') || result.data[0];
                    
                    document.getElementById('page-token').value = targetPage.access_token;
                    document.getElementById('page-id').value = targetPage.id;
                    
                    // Debug the page token
                    await debugPageToken(targetPage.access_token);
                    
                    showNotification(`‚úÖ Page Token Generated: ${targetPage.name}`, 'success');
                    
                } else if (result.error) {
                    showNotification(`‚ùå Error: ${result.error.message}`, 'error');
                }

            } catch (error) {
                showNotification('‚ùå Network error: ' + error.message, 'error');
            }
        }

        // Debug Page Token
        async function debugPageToken(token) {
            try {
                const debugResponse = await fetch(`https://graph.facebook.com/debug_token?input_token=${token}&access_token=${token}`);
                const debugResult = await debugResponse.json();
                
                const debugDiv = document.getElementById('debug-result');
                
                if (debugResult.data) {
                    const data = debugResult.data;
                    debugDiv.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 3px solid #3b82f6;">
                            <h4 style="color: #2563eb;">üîç TOKEN DEBUG RESULTS:</h4>
                            <div style="font-family: monospace; font-size: 14px; line-height: 1.8;">
                                <strong>Valid:</strong> ${data.is_valid ? '‚úÖ YES' : '‚ùå NO'}<br>
                                <strong>Type:</strong> ${data.type || 'N/A'}<br>
                                <strong>App ID:</strong> ${data.app_id || 'N/A'}<br>
                                <strong>Expires:</strong> ${data.expires_at ? new Date(data.expires_at * 1000).toLocaleString() : 'Never'}<br>
                                <strong>Permissions:</strong> ${data.scopes ? data.scopes.join(', ') : 'N/A'}<br>
                                <strong>Has pages_manage_posts:</strong> ${data.scopes && data.scopes.includes('pages_manage_posts') ? '‚úÖ YES' : '‚ùå NO'}<br>
                                <strong>Has pages_read_engagement:</strong> ${data.scopes && data.scopes.includes('pages_read_engagement') ? '‚úÖ YES' : '‚ùå NO'}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Debug error:', error);
            }
        }

        // Save final config
        window.saveFinalConfig = function() {
            const token = document.getElementById('page-token').value.trim();
            const pageId = document.getElementById('page-id').value.trim();

            if (!token) {
                showNotification('‚ùå Please generate Page Token first', 'error');
                return;
            }

            config = { token, pageId };
            localStorage.setItem('finalConfig', JSON.stringify(config));
            showNotification('‚úÖ Final configuration saved successfully!', 'success');
        }

        // Test final connection
        window.testFinalConnection = async function() {
            if (!config.token) {
                showNotification('‚ùå Please save configuration first', 'error');
                return;
            }

            try {
                showNotification('üîó Testing Final Connection...', 'warning');
                
                const response = await fetch(`https://graph.facebook.com/v18.0/${config.pageId}?fields=name,perms,tasks&access_token=${config.token}`);
                const result = await response.json();

                console.log('Final Connection Test:', result);

                if (result.name) {
                    const canPost = result.tasks && result.tasks.includes('CREATE_CONTENT');
                    showNotification(
                        `‚úÖ FINAL CONNECTION SUCCESS!<br>
                         üè™ Page: ${result.name}<br>
                         üìù Can Post: ${canPost ? '‚úÖ YES' : '‚ùå NO'}<br>
                         üîë Permissions: ${result.perms ? result.perms.join(', ') : 'N/A'}`,
                        canPost ? 'success' : 'warning'
                    );
                } else {
                    showNotification(`‚ùå Connection failed: ${result.error?.message}`, 'error');
                }

            } catch (error) {
                showNotification('‚ùå Connection error: ' + error.message, 'error');
            }
        }

        // üöÄ ULTIMATE FINAL POST FUNCTION
        window.ultimateFinalPost = async function() {
            if (!config.token) {
                showNotification('‚ùå Please configure token first', 'error');
                return;
            }

            const pendingProducts = products.filter(p => !p.posted_to_facebook);
            if (pendingProducts.length === 0) {
                showNotification('‚úÖ All products already posted!', 'success');
                return;
            }

            showNotification(`üöÄ Starting ULTIMATE FINAL auto-post for ${pendingProducts.length} products...`, 'warning');
            
            let successCount = 0;

            for (let i = 0; i < pendingProducts.length; i++) {
                const product = pendingProducts[i];
                
                showNotification(`üì§ ${i+1}/${pendingProducts.length}: ${product.stone_name}`, 'warning');

                const result = await ultimatePostToFacebook(product);
                
                if (result.success) {
                    await updateDoc(doc(db, "products", product.id), {
                        posted_to_facebook: true,
                        facebook_post_id: result.post_id,
                        facebook_post_url: result.post_url,
                        posted_at: serverTimestamp(),
                        post_method: 'Ultimate Final'
                    });
                    successCount++;
                    
                    showNotification(`‚úÖ ${i+1}. ${product.stone_name} - ULTIMATE SUCCESS!`, 'success');
                    
                    // Open post in new tab
                    if (result.post_url) {
                        setTimeout(() => {
                            window.open(result.post_url, '_blank');
                        }, 1000);
                    }
                } else {
                    showNotification(`‚ùå ${i+1}. ${product.stone_name} - ${result.error}`, 'error');
                }

                await new Promise(resolve => setTimeout(resolve, 4000));
            }

            await loadProducts();
            
            showNotification(
                `üéâ ULTIMATE FINAL COMPLETED!<br>
                 ‚úÖ ${successCount} Successfully Posted<br>
                 üìä Success Rate: ${((successCount/pendingProducts.length)*100).toFixed(1)}%<br>
                 üéä All products now on Facebook!`,
                'success'
            );
        }

        // üéØ ULTIMATE POST TO FACEBOOK
        async function ultimatePostToFacebook(product) {
            const token = config.token;
            const pageId = config.pageId;

            const message = `üè™ RJ MULTI STONE HUB - OFFICIAL

üèõÔ∏è PRODUCT: ${product.stone_name}
üí∞ PRICE: ‚Çπ${product.price || 'Contact'} ${product.price_unit || ''}
üì¶ CATEGORY: ${product.category || 'Natural Stone'}

${product.description || 'Premium quality natural stone directly from Rajasthan mines. Best for construction, flooring, and wall cladding.'}

‚úÖ 100% Quality Guaranteed
üìû Contact for Bulk Orders
üöö Free Delivery Available
‚≠ê Trusted Supplier

#RajasthanStones #NaturalStone #Construction #BuildingMaterials #RJMultiStoneHub`;

            try {
                console.log('üîÑ Ultimate Posting:', product.stone_name);
                
                const response = await fetch(`https://graph.facebook.com/v18.0/${pageId}/feed`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        access_token: token,
                        published: true
                    })
                });

                const result = await response.json();
                console.log('Ultimate API Response:', result);

                if (result.id) {
                    return {
                        success: true,
                        post_id: result.id,
                        post_url: `https://www.facebook.com/${result.id.replace('_', '/posts/')}`
                    };
                } else {
                    return {
                        success: false,
                        error: result.error?.message || 'API Error'
                    };
                }

            } catch (error) {
                return {
                    success: false,
                    error: 'Network: ' + error.message
                };
            }
        }

        // Load products
        window.loadProducts = async function() {
            try {
                showNotification('üì• Loading products...', 'warning');
                const querySnapshot = await getDocs(collection(db, "products"));
                products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProducts();
                showNotification(`‚úÖ ${products.length} products loaded`, 'success');
            } catch (error) {
                showNotification('‚ùå Load error: ' + error.message, 'error');
            }
        }

        // Render products
        function renderProducts() {
            const container = document.getElementById('products-container');
            if (products.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üì¶</div>
                        <h3>No products in database</h3>
                    </div>
                `;
                return;
            }

            const postedCount = products.filter(p => p.posted_to_facebook).length;
            const pendingCount = products.length - postedCount;

            container.innerHTML = `
                <div class="section">
                    <h2 style="color: #2563eb;">üìä PRODUCTS SUMMARY</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; text-align: center;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 25px; border-radius: 15px;">
                            <h2 style="font-size: 2.5rem; margin: 0;">${products.length}</h2>
                            <p style="font-size: 1.2rem;">Total Products</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #16a34a, #22c55e); color: white; padding: 25px; border-radius: 15px;">
                            <h2 style="font-size: 2.5rem; margin: 0;">${postedCount}</h2>
                            <p style="font-size: 1.2rem;">Posted</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 25px; border-radius: 15px;">
                            <h2 style="font-size: 2.5rem; margin: 0;">${pendingCount}</h2>
                            <p style="font-size: 1.2rem;">Pending</p>
                        </div>
                    </div>
                </div>
                <div class="product-grid">
                    ${products.map(product => `
                        <div class="product-card">
                            <img src="${product.images?.[0] || 'https://via.placeholder.com/400x200/3b82f6/white?text=STONE+PRODUCT'}" 
                                 class="product-image" alt="${product.stone_name}">
                            <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.4rem;">${product.stone_name}</h3>
                            <p style="font-size: 1.3rem; font-weight: bold; color: #dc2626;">üí∞ ‚Çπ${product.price || 'N/A'} ${product.price_unit || ''}</p>
                            <p style="color: #475569; font-size: 1.1rem;">üì¶ ${product.category || 'Natural Stone'}</p>
                            <div style="background: ${product.posted_to_facebook ? '#dcfce7' : '#fef3c7'}; 
                                         padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; font-weight: bold; font-size: 1.1rem; border: 3px solid ${product.posted_to_facebook ? '#16a34a' : '#d97706'};">
                                ${product.posted_to_facebook ? '‚úÖ POSTED TO FACEBOOK' : '‚è≥ READY FOR POSTING'}
                            </div>
                            <button class="btn ${product.posted_to_facebook ? 'btn-primary' : 'btn-success'}" 
                                    onclick="postSingleUltimate('${product.id}')" 
                                    style="width: 100%; font-size: 1.2rem;">
                                ${product.posted_to_facebook ? 'üëÄ VIEW POST' : 'üöÄ ULTIMATE POST'}
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Single product ultimate post
        window.postSingleUltimate = async function(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            if (product.posted_to_facebook && product.facebook_post_url) {
                window.open(product.facebook_post_url, '_blank');
                return;
            }

            showNotification(`üöÄ ULTIMATE POST: ${product.stone_name}`, 'warning');
            const result = await ultimatePostToFacebook(product);
            
            if (result.success) {
                await updateDoc(doc(db, "products", productId), {
                    posted_to_facebook: true,
                    facebook_post_id: result.post_id,
                    facebook_post_url: result.post_url,
                    posted_at: serverTimestamp()
                });
                await loadProducts();
                showNotification(`‚úÖ ULTIMATE SUCCESS: ${product.stone_name}`, 'success');
                
                // Auto-open the post
                setTimeout(() => {
                    window.open(result.post_url, '_blank');
                }, 1000);
            } else {
                showNotification(`‚ùå ULTIMATE FAILED: ${result.error}`, 'error');
            }
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.className = `notification ${type}`;
        }

        // Initialize
        loadConfig();
        loadProducts();

        // Show initial instructions
        setTimeout(() => {
            showNotification(
                `üö® <strong>CRITICAL: Complete these steps to fix 403 error:</strong><br><br>
                1. <strong>Click "OPEN APP DASHBOARD"</strong><br>
                2. <strong>Switch app to "LIVE" mode</strong><br>
                3. <strong>Request "pages_manage_posts" permission</strong><br>
                4. <strong>Click "GENERATE & DEBUG TOKEN"</strong><br>
                5. <strong>Verify permissions show ‚úÖ YES</strong><br>
                6. <strong>Click "ULTIMATE FINAL AUTO POST"</strong>`,
                'warning'
            );
        }, 2000);
    </script>
</body>
</html>
